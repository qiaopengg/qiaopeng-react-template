# GitLab CI/CD é…ç½®
image: node:20

# å®šä¹‰é˜¶æ®µ
stages:
  - install
  - check
  - build

# ç¼“å­˜é…ç½®ï¼ˆåŠ é€Ÿæ„å»ºï¼‰
cache:
  key:
    files:
      - package-lock.json
  paths:
    - node_modules/
    - .npm/
    - node_modules/.cache/

# å®‰è£…ä¾èµ–
install:
  stage: install
  script:
    - echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
    - npm ci --cache .npm --prefer-offline
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 hour
  only:
    - merge_requests
    - main
    - develop

# ä»£ç è´¨é‡æ£€æŸ¥ï¼ˆåªæ£€æŸ¥å˜æ›´æ–‡ä»¶ï¼‰
code-quality:
  stage: check
  needs: ["install"]
  before_script:
    - echo "ğŸ” å‡†å¤‡æ£€æŸ¥å˜æ›´æ–‡ä»¶..."
  script:
    # æ ¼å¼æ£€æŸ¥ï¼ˆåªæ£€æŸ¥å˜æ›´æ–‡ä»¶ï¼‰
    - |
      if [ "$CI_MERGE_REQUEST_IID" ]; then
        echo "ğŸ“ æ£€æŸ¥ä»£ç æ ¼å¼..."
        CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR origin/$CI_MERGE_REQUEST_TARGET_BRANCH_NAME...HEAD || true)

        if [ -n "$CHANGED_FILES" ]; then
          echo "$CHANGED_FILES" | xargs npx prettier --check || {
            echo "âŒ æ ¼å¼æ£€æŸ¥å¤±è´¥ï¼è¯·è¿è¡Œ 'npm run format' ä¿®å¤"
            exit 1
          }
        fi
      else
        npm run format:check
      fi

    # ESLint æ£€æŸ¥ï¼ˆåªæ£€æŸ¥å˜æ›´çš„ JS/TS æ–‡ä»¶ï¼‰
    - |
      if [ "$CI_MERGE_REQUEST_IID" ]; then
        echo "ğŸ” ESLint æ£€æŸ¥..."
        CHANGED_JS_FILES=$(git diff --name-only --diff-filter=ACMR origin/$CI_MERGE_REQUEST_TARGET_BRANCH_NAME...HEAD | grep -E '\.(ts|tsx|js|jsx)$' || true)

        if [ -n "$CHANGED_JS_FILES" ]; then
          echo "$CHANGED_JS_FILES" | xargs npx eslint --max-warnings 0 || {
            echo "âŒ ESLint æ£€æŸ¥å¤±è´¥ï¼è¯·è¿è¡Œ 'npm run lint:es:fix' ä¿®å¤"
            exit 1
          }
        else
          echo "âœ… æ²¡æœ‰ JS/TS æ–‡ä»¶å˜æ›´"
        fi
      else
        npm run lint:es
      fi

    # Stylelint æ£€æŸ¥ï¼ˆåªæ£€æŸ¥å˜æ›´çš„æ ·å¼æ–‡ä»¶ï¼‰
    - |
      if [ "$CI_MERGE_REQUEST_IID" ]; then
        echo "ğŸ¨ Stylelint æ£€æŸ¥..."
        CHANGED_CSS_FILES=$(git diff --name-only --diff-filter=ACMR origin/$CI_MERGE_REQUEST_TARGET_BRANCH_NAME...HEAD | grep -E '\.(css|scss|less)$' || true)

        if [ -n "$CHANGED_CSS_FILES" ]; then
          echo "$CHANGED_CSS_FILES" | xargs npx stylelint || {
            echo "âŒ Stylelint æ£€æŸ¥å¤±è´¥ï¼è¯·è¿è¡Œ 'npm run lint:style:fix' ä¿®å¤"
            exit 1
          }
        else
          echo "âœ… æ²¡æœ‰æ ·å¼æ–‡ä»¶å˜æ›´"
        fi
      else
        npm run lint:style
      fi

    # TypeScript ç±»å‹æ£€æŸ¥ï¼ˆå…¨é‡ï¼‰
    - |
      echo "ğŸ“˜ TypeScript ç±»å‹æ£€æŸ¥..."
      npm run lint:type || {
        echo "âŒ ç±»å‹æ£€æŸ¥å¤±è´¥ï¼è¯·ä¿®å¤ç±»å‹é”™è¯¯"
        exit 1
      }

    - echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼"

  allow_failure: false
  only:
    - merge_requests
    - main
    - develop

# æ„å»ºæ£€æŸ¥
build:
  stage: build
  needs: ["install", "code-quality"]
  script:
    - echo "ğŸ—ï¸ æ„å»ºé¡¹ç›®..."
    - npm run build
    - echo "âœ… æ„å»ºæˆåŠŸï¼"
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop
